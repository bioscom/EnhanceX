{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load static %}
{% load table_tags %}

{% load widget_tweaks %}
{% load crispy_forms_tags %}

{% block title %} Dashboards {% endblock %}

{% block body %}

    <style>
        th {
            {% comment %} white-space: nowrap; {% endcomment %}
        }
    
        td {
            {% comment %} white-space: nowrap; {% endcomment %}
        }
    </style>

    {% include 'management/header.html' %}


    <style>
        .resize {
            width: 100% !important;
            height: 200px !important;
        }

        .resize2 {
            width: 100% !important;
            height: 100px !important;
        }
    </style>

    <style>
        .zoom-card {
            transition: transform 0.4s ease, top 0.4s ease, left 0.4s ease;
            position: relative;
            z-index: 1;
        }

        .zoomed-in {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80vw;  /* 80% of viewport width */
            max-height: 80vh; /* optional: prevent vertical overflow */
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 1050; /* above Bootstrap modals */
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
            background-color: white;
        }

        .zoom-toggle-icon {
            float: right;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .table-font{
            font-size: 14px
        }

    </style> 

    <form action="{% url 'dashboard:add_opex_recognition' %}" method="POST">
        {% csrf_token %}
        {{ form.media }}
        <div class="modal fade" id="opexRecognitionModal" tabindex="-1" aria-labelledby="impactModalLabel" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="impactModalLabel">Update Opex Recognition</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% include 'partials/partial_add_opex_recognition.html' %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <form action="{% url 'dashboard:add_opex_target' %}" method="POST">
        {% csrf_token %}
        <div class="modal fade" id="opexTargetModal" tabindex="-1" aria-labelledby="impactModalLabel" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="impactModalLabel">Update Opex Target</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% include 'partials/partial_add_opex_target.html' %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <form method="POST">
        {% csrf_token %}
        <div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="syncModalLabel">Sync this week Opex Data</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center">
                            Are you sure you selected current year, {% now "Y" %}, for today's {% now "l, jS F Y" %}, Renaissance Opex Initiatives Report?<br><br>
                            If you are not sure, kindly click No and go back to select the right report.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <button type="submit" class="btn btn-primary">Yes</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <form id="checkboxForm" action="{% url 'dashboard:trigger_opex_data_copy' %}" method="POST">
        {% csrf_token %}
        <div class="modal fade" id="listReportModal" tabindex="-1" aria-labelledby="impactModalLabel" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title" id="impactModalLabel">Select This Year's Opex Report</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="col-md-12 text-danger mb-2"> 
                            <b>‚ö†Ô∏è Important:</b>
                            You are required to select the <b>OPEX Report for the current year</b><br>
                            and copy it to the database. Please verify that the correct report is selected before proceeding. 
                        </div>
                        {% include 'partials/partial_show_reports.html' %}  <!-- Can be shared-->
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#syncModal">Sync Data for this week</button>
                        {% comment %} 
                            <button id="syncButton" type="submit" class="btn btn-primary">Sync Data for this week</button>
                        {% endcomment %}
                        <div id="availabilityNote" class="text-muted small">
                            üîí This button will be available from <strong>Friday 9:00 AM</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="card mb-2">
        <div class="card-body">
            <div class="col-sm-12">
                <div class="row ms-2">
                    <div class="col-sm-1">
                        <div class="col-sm fw-bold">Report Week</div>
                        <div class="col-sm">
                            <select name="reportWeek" id="reportWeek" class="form-select mb-2">
                                {% for o in oWeeks %}
                                    <option value="{{ o }}" {% if oWeekTW|stringformat:"s" == o|stringformat:"s" %}selected{% endif %}>{{ o }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-1">
                        <div class="col-sm fw-bold">Functions</div>
                        <div class="col-sm">
                            <select id="functionFilter" class="form-select mb-2">
                                <option value="">All</option>
                                {% for o in xfunctions %}
                                    <option value="{{o.id}}" {% if request.GET.functionFilter == o.id|stringformat:"s" %}selected{% endif %}>{{ o.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-sm-8 text-center d-flex align-items-center">
                        <h2>{{oYear}} Renaissance Opex Dashboard (100%)</h2>
                    </div>
                    
                    <div class="col-sm-2 d-flex align-items-center text-end">
                        {% if request.user.is_staff %}
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#listReportModal">Sync this week's Opex data</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    <div class="card col-sm-12">
        <div class="card-body">
            <div id="ajaxReportContainer">
                {% include "management/opex/ajax_partial.html" %}
            </div>
        </div>
    </div><br><br><br>
    
{% endblock %}


{% block js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const zoomIcons = document.querySelectorAll('[data-zoom-btn]');

            zoomIcons.forEach(icon => {
            icon.addEventListener('click', function (e) {
                e.stopPropagation(); // prevent event bubbling
                const card = icon.closest('.zoom-card');

                // Remove zoom from all others
                document.querySelectorAll('.zoom-card.zoomed-in').forEach(c => {
                if (c !== card) c.classList.remove('zoomed-in');
                });

                // Toggle this card
                card.classList.toggle('zoomed-in');
            });
            });
        });
    </script>

    <script>
        function isThursdayAfter3PM() {
            const now = new Date();
            const isThursday = now.getDay() === 5; // 0=Sunday, 4=Thursday
            const isAfter3PM = now.getHours() >= 9;
            return isThursday && isAfter3PM;
        }

        window.addEventListener('DOMContentLoaded', () => {
            const syncButton = document.getElementById('syncButton');
            const availabilityNote = document.getElementById('availabilityNote');

            if (isThursdayAfter3PM()) {
            syncButton.disabled = false;
            availabilityNote.style.display = 'none';
            } else {
            syncButton.disabled = true;
            availabilityNote.style.display = 'block';
            syncButton.title = "Button active only on Fridays from 9AM";
            }
        });
    </script>
{% endblock %}