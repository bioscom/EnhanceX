{% load humanize %}

<div class="container-fluid p-1 bg-success">
  <!-- Row 1: Header and KPIs -->
    <div class="row">
        <!-- Column 1 -->
        <div class="col-md-1">
            <div class="card col-md g-1 mb-1">
                <div class="card-header">
                    {% if request.user.is_staff %}
                        <a type="button" data-bs-toggle="modal" data-bs-target="#opexTargetModal" title="Click to update Opex Target for the current Year"><b>Opex Target</b></a>
                    {% else %}
                        <b>Opex Target</b>
                    {% endif %}
                </div>
                <div class="card-body">
                    <h3 class="text-center">$50M</h3>
                </div>
            </div>

            {% comment %} <div class="card col-md mb-1">
                <div class="card-header">
                    <h6>Functions</h6>
                </div>
                <div class="card-body">
                    <select id="functionFilter" class="form-select mb-2">
                        <option value="">All</option>
                        {% for o in xfunctions %}
                            <option value="{{o.id}}" {% if request.GET.functionFilter == o.id|stringformat:"s" %}selected{% endif %}>{{ o.title }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="card col-md mb-1">
                <div class="card-header">
                    <h6 class="small">Report Week</h6>
                </div>
                <div class="card-body">
                    <select name="reportWeek" id="reportWeek" class="form-select mb-2">
                        {% for o in oWeeks %}
                            <option value="{{o}}" {% if request.GET.reportWeek == o|stringformat:"s" %}selected{% endif %}>{{ o }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div> {% endcomment %}
        
            <div class="card col-md mb-1">
                <div class="card-header">
                    <h6 class="small">Current Week</h6>
                </div>
                <div class="card-body">
                    <h1 class="text-center">{{oWeekTW}}</h1>
                </div>
            </div>

            <div class="card col-md mb-1">
                <div class="card-header">
                    <h6>Funnel Size</h6>
                </div>
                <div class="card-body">
                    <h4 class="text-center">${{FunnelSize}}M</h4>
                </div>
            </div>

            <div class="card col-md">
                <div class="card-header">
                    <h6 class="small" title="Initiative Count">Initiative Count</h6>
                </div>
                <div class="card-body">
                    <h2 class="text-center" title="Initiative Count">{{record}}</h2>
                </div>
            </div>
        </div>
        <!-- Column 2 -->
        <div class="col-md-8">
            <div class="col-md-12">
                <div class="row">
                    <div class="card col-md-3">
                        <div class="card-header">
                            <h6>Opex Funnel</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="funnelChart" class="resize"></canvas>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="row g-1 mb-2 h-50">
                            <div class="card col-md">
                                <div class="card-header">
                                    <h6>Funnel Value Below L3</h6>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-center">${{funnelBelowG3}}M</h3>
                                </div>
                            </div>

                            <div class="card col-md">
                                <div class="card-header">
                                    <h6>Funnel Growth - Week</h6>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-center">${{FunnelGrowth}}M</h3>
                                </div>
                            </div>
                        </div>

                        <div class="row g-1 h-50">
                            <div class="card col-md">
                                <div class="card-header">
                                    <h6>Banked YTD</h6>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-success text-center">${{BankedYTD}}M</h3>
                                </div>
                            </div>
                            <div class="card col-md">
                                <div class="card-header">
                                    <h6>Banked This Week</h6>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-success text-center">${{TotalBankedTW}}M</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card col-md-2">
                        <div class="card-header">
                            <h6>Pipeline Robustness</h6>
                        </div>
                        <div class="card-body">
                            <div class="resize">
                                <h5>Target 150%</h5>
                                <h1 class="d-flex justify-content-center align-items-center text-warning mt-5">{{pipeLineRobustness}}%</h1>
                            </div>
                        </div>
                    </div>

                    <div class="card col-md-3">
                        <div class="card-header">
                            <h6>Banked YTD by Functions</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="bankedYTDChart"></canvas>
                            {{ chart_labels|json_script:"chart-labels" }}
                            {{ chart_data|json_script:"chart-data" }}
                        </div>
                    </div>
                </div>

                <div class="row mt-1">
                    <div class="card zoom-card col-md-12">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6>Funnel Value by Functions/Assets</h6>
                            {% comment %} <span class="zoom-toggle-icon" title="Zoom" data-zoom-btn><i class="fas fa-expand-arrows-alt"></i></span> {% endcomment %}
                        </div>
                        <div class="card-body">
                            <canvas id="funnelValueChart" height="90"></canvas>
                        </div>
                    </div>
                    <div class="row g-1 h-100">
                        <div class="card zoom-card col-md-6">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6>Initiative Movement to L3+</h6>
                                <span class="zoom-toggle-icon" title="Zoom" data-zoom-btn><i class="fas fa-expand-arrows-alt"></i></span>
                            </div>
                            <div class="card-body">
                                <canvas id="l3InitiativeMovementChart"></canvas>
                            </div>
                        </div>

                        <div class="card zoom-card col-md-6 g-1">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6>Total & New Initiative Count per Function/Asset</h6>
                                <span class="zoom-toggle-icon" title="Zoom" data-zoom-btn><i class="fas fa-expand-arrows-alt"></i></span> 
                            </div>
                            <div class="card-body">
                                <canvas id="initiativeCountChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="lgateChart" height="35px"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Column 3 -->
        <div class="col-md-3">
            <div class="card zoom-card mb-1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="col-sm">
                        {% if request.user.is_staff %}
                            <a type="button" data-bs-toggle="modal" data-bs-target="#opexRecognitionModal" title="Click to update Opex Recognition"><b>Recognition</b></a>
                        {% else %}
                            <b>Recognition</b>
                        {% endif %}
                    </div>
                    <span class="zoom-toggle-icon" title="Zoom" data-zoom-btn><i class="fas fa-expand-arrows-alt"></i></span>
                </div>
                <div class="card-body" style="height: 30vh; overflow-y; auto;">
                    {{opexRecognition.recognition|safe}}
                </div>
            </div>
            
            <div class="card zoom-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>Top Initiatives</h6>
                    <span class="zoom-toggle-icon" title="Zoom" data-zoom-btn><i class="fas fa-expand-arrows-alt"></i></span>
                </div>
                <div class="card-body">
                    <div class="table-responsive shadow scroll-container">
                        <table id="opexTopInitiatives" class="table table-bordered table-hover table-font">
                            <thead class="table-light" style="position: sticky; top:0; z-index:1";>     
                                <tr>
                                    <th></th>
                                    <th>Id</th>
                                    <th>Initiative Name</th>
                                    <th>Actual Gate</th>
                                    <th>Planned Value</th>
                                    <th>Banked Opex</th>
                                    <th>Benefit Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% comment %} {% for o in topInitiatives|slice:":20" %} {% endcomment %}
                                {% for o in topInitiatives %}
                                    {% if o.initiative_name in duplicates %}
                                        <tr class="table-danger">
                                    {% else %}
                                        <tr>
                                    {% endif %}
                                        <td>{{forloop.counter}}</td>
                                        <td>{{o.initiative_id}}</td>
                                        <td><a href="{% url 'Fit4:initiative_details' o.slug %}">{{o.initiative_name}}</a></td>
                                        <td>{{o.actual_Lgate}}</td>
                                        <td class="text-end">{{o.Yearly_Planned_Value|floatformat:2|intcomma}}</td>
                                        <td>{{o.Yearly_Actual_value|floatformat:2|intcomma}}</td>
                                        <td>{{o.benefittype.title}}</td>
                                        <td>
                                            {% if o.initiative_name in duplicates %}
                                                <!-- Only show delete on first duplicate -->
                                                <form method="POST" action="{% url 'dashboard:delete_opex_duplicate' o.id %}" style="display:inline;">
                                                    {% csrf_token %}
                                                    <button class="btn btn-sm btn-danger" onclick="return confirm('Delete this duplicate?')">Delete</button>
                                                </form>
                                            {% else %}
                                                <a href="{% url 'dashboard:edit_opex_initiative_report' o.id %}" class="btn btn-sm btn-warning">Edit</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Row 4: Funnel Stage Summary -->
    {% comment %} <div class="col-md-12">
        <div class="border p-2 bg-white text-center">
            <div class="d-flex justify-content-center">
                <canvas id="lgateChart" height="20"></canvas>
            </div>
        </div>
    </div> {% endcomment %}
    <div class="row mb-2 mt-2 text-light">
        <div class="col-sm-10 text-end">
            <b>Dashboard Last Updated</b>
        </div>
        <div class="col-sm-2">
            <b>{{LastUpdated|date:'d-M-Y H:i'}}</b>
        </div>
    </div>
</div>

<script>
  const table = document.getElementById("opexTopInitiatives");
  const rows = table.querySelectorAll("tbody tr");

  // Step 1: Collect values from column index 1 (Name column)
  const names = Array.from(rows).map(row => row.cells[1].textContent.trim());

  // Step 2: Count occurrences
  const counts = {};
  names.forEach(name => {
    counts[name] = (counts[name] || 0) + 1;
  });

  // Step 3: Highlight cells with duplicates
  rows.forEach(row => {
    const nameCell = row.cells[1];
    if (counts[nameCell.textContent.trim()] > 1) {
      nameCell.style.color = "red";
      // Or highlight entire row:
      // row.style.backgroundColor = "#f8d7da";
    }
  });
</script>

<script>
    document.getElementById('reportWeek').addEventListener('change', function () {
    const week = this.value;
    const year = new Date().getFullYear(); // or pass actual year dynamically

    fetch(`opex/ajax/load-week-data/?week=${week}&year=${year}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('ajaxReportContainer').innerHTML = data.html;
                renderOpexCharts();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Load Failed',
                    html: `<strong>Error:</strong> ${data.error}`,
                    confirmButtonText: 'Close'
                });
            }
        })
        .catch((error) => {
            Swal.fire({
                icon: 'error',
                title: 'Load Failed',
                //text: 'Could not fetch week report. Try again.',
                html: `<b>Error:</b> ${error.message || 'Unknown error occurred.'}`,
                confirmButtonText: 'Close'
            });
        });
    });
</script>