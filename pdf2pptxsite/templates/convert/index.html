{% extends "base.html" %}
{% load i18n %}

{% load static %}
{% load table_tags %}

{% load widget_tweaks %}
{% load crispy_forms_tags %}

{% block title %} PDF to Editable PowerPoint {% endblock %}

{% block body %}

    <style>
        {% comment %} body { font-family: Arial; text-align: center;} {% endcomment %}
       
        .dropzone { border: 2px dashed #999; 
          padding: 30px; 
          background: #f8f9fa; 
          text-align: center; 
          cursor: pointer; 
          margin-bottom: 20px; 
        }
        .file-box { margin-bottom: 30px; }
        iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 10px; }
        .progress { height: 20px; margin-top: 10px; }
    </style>


  {% comment %} <div class="card">
    <div class="card-header">
        <h5>Drag and Drop PDFs to Convert to Editable PowerPoint</h5>
    </div>
    <div class="card-body">
      <form action="{% url 'pdf2pptxsite:convert_to_pptx' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="dropzone" ondrop="handleDrop(event)" ondragover="event.preventDefault()">
          Drop PDF files here or click to browse
          <input type="file" name="files[]" multiple style="display:none;" onchange="this.form.submit()" />
        </div>
        <div class="d-flex justify-content-center align-items-center">
          <input type="submit" value="Convert" class="btn btn-primary w-25 mt-3"> 
        </div>
      </form>

      <form id="upload-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
          <!-- LEFT: Dropzone + PDF Preview -->
          <div class="col-md-6">
            <div id="dropzone" class="dropzone">
              <p>Drop PDF here or click to browse</p>
              <input type="file" name="files" id="file-input" accept="application/pdf" hidden />
            </div>
            <iframe id="pdf-preview" class="mt-3 d-none"></iframe>
          </div>

          <!-- RIGHT: Converted file download -->
          <div class="col-md-6">
            <div class="preview-box" id="output-box">
              <p class="text-muted">Converted file will appear here</p>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div> {% endcomment %}


  <div class="container">
    <h3 class="text-center mb-4">Multi PDF âžœ Editable PPTX Converter</h3>

    <div id="dropzone" class="dropzone">
      <p>Drop PDF files here or click to upload</p>
      <input id="file-input" type="file" accept="application/pdf" hidden multiple>
    </div>

    <div id="file-preview-area"></div>
  </div>

  
  
  
{% endblock %}



{% block js %}
  <script>
      function handleDrop(e) {
        e.preventDefault();
        const input = document.querySelector('input[type=file]');
        input.files = e.dataTransfer.files;
        input.form.submit();
      }
      document.querySelector('.dropzone').addEventListener('click', () => {
        document.querySelector('input[type=file]').click();
      });



      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('file-input');
      const pdfPreview = document.getElementById('pdf-preview');
      const outputBox = document.getElementById('output-box');
      const form = document.getElementById('upload-form');

      // Click to upload
      dropzone.addEventListener('click', () => fileInput.click());

      // Handle file drop
      dropzone.addEventListener('dragover', e => e.preventDefault());
      dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        fileInput.files = e.dataTransfer.files;
        handleFilePreview(fileInput.files[0]);
        form.submit();
      });

      // Show PDF preview
      fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
          handleFilePreview(this.files[0]);
          form.submit();
        }
      });

      function handleFilePreview(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          pdfPreview.src = e.target.result;
          pdfPreview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
      }

      // After POST, Django/Flask should return ZIP or PPTX, this part can be enhanced if using AJAX
      // For now, backend just sends the file directly
  </script>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("file-input");
    const previewArea = document.getElementById("file-preview-area");

    dropzone.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("dragover", e => e.preventDefault());
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener("change", () => handleFiles(fileInput.files));

    function handleFiles(files) {
      [...files].forEach(file => {
        if (file.type === "application/pdf") {
          const box = document.createElement("div");
          box.className = "file-box border rounded p-3";
          box.innerHTML = `
            <h6>${file.name}</h6>
            <iframe class="d-none"></iframe>
            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div class="result mt-3 text-center text-muted">Uploading...</div>
          `;
          previewArea.appendChild(box);

          const iframe = box.querySelector("iframe");
          const progressBar = box.querySelector(".progress-bar");
          const resultBox = box.querySelector(".result");

          const reader = new FileReader();
          reader.onload = (e) => {
            iframe.src = e.target.result;
            iframe.classList.remove("d-none");
          };
          reader.readAsDataURL(file);

          const formData = new FormData();
          formData.append("file", file);

          axios.post("/convert/", formData, {
            onUploadProgress: (progressEvent) => {
              let percent = Math.round((progressEvent.loaded * 100) / progressEvent.total);
              progressBar.style.width = percent + "%";
              progressBar.textContent = percent + "%";
            }
          })
          .then(res => {
            if (res.data.status === "success") {
              resultBox.innerHTML = `<a href="${res.data.url}" class="btn btn-success" download>Download ${file.name.replace('.pdf', '.pptx')}</a>`;
            } else {
              resultBox.innerHTML = `<span class="text-danger">Failed to convert.</span>`;
            }
          })
          .catch(() => {
            resultBox.innerHTML = `<span class="text-danger">Error occurred during upload.</span>`;
          });
        }
      });
    }
  </script>
{% endblock %}